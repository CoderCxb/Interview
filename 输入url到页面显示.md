### 1. **输入url到页面加载都发生了什么事情？**

##### 1.1 输入URL并解析

a)输入URL后,浏览器会对URL进行解析,获取URL中包含的协议、主机、端口、路径、参数等.

b)在浏览器发送HTTP请求前,首先根据请求头中的`expires`和`cache-control`判断是否命中强缓存(命中则看强缓存是否过期),如果命中,则直接从缓存中获取资源,不会往服务器发送请求。

c)没有命中强缓存时,浏览器会发送请求，根据请求头的`Last-Modified 和 If-Modified-Since`或 `etag 和 If-Match`判断是否命中协商缓存(推荐etag)，如果命中，直接从 缓存获取资源。如果没有命中，则进入下一步。

d)都没有命中时，则直接从服务器获取资源。

##### 1.2 DNS域名解析
1. 检查浏览器的缓存
2. 首先查看本机的hosts文件
3. 本地DNS的缓存(访问过会有缓存)
4. DNS服务器缓存(前两个都没有时，向DNS服务器查询,DNS服务器也是优先查找自己本地缓存)
5. DNS服务器查找(DNS没有缓存时,递归查找) ,如 www.baidu.com. 这个域名,默认情况下末尾的.会被省略(等价于.root)。首先查询根域名.root, 获取顶级域名 .com的NS(Name Server - 名称) 和 A(Address - ip地址), 然后再查询顶级域名获取二级域名 .baidu.com的NS和A,再查询二级域名获取 www.baidu.com的NS和A.
6. 这时浏览器就获取到了这个域名对应的ip地址,并会对其进行缓存,不同的浏览器的缓存时间也不同。
7. DNS还有负载均衡的功能,当一个网站对应多个服务器的时候,在相应DNS查询的时候，对不同的查询返回不同的解析结果(ip地址)，这样访问就会被分散开,达到负载均衡的效果。

##### 1.3 TCP/IP连接

**三次握手:**
 - 客户端向服务器发送一个带有SYN标志的数据报给服务器(确保浏览器的发送能力)
 - 服务器接收到后,向客户端返回一个带有SYN/ACK的数据包表示确认 (确保服务器的发送能力)
 - 客户端接受到后再发送一个带有ACK标志的数据报, 握手结束。(确保浏览器的接收能力)



##### 1.4  HTTP 请求

![img](images\4.jpg)

**HTTPS**

在HTTP的基础上加上一层TLS(传输层安全性协议)或 SSL(安全套接层),就构成了HTTPS.

##### 1.5 服务器处理请求并返回HTTP报文

服务器上会安装Web Server，如apche、nginx、IIS等。

HTTP请求一般可分为2类:静态资源和动态资源，静态资源直接根据url地址去服务器中找，动态资源则需要根据相应的程序处理，比如 node写的api接口，然后将程序处理的结果返回给浏览器。

##### 1.6 浏览器渲染页面
![img](images\5.jpg)
1. 将HTML解析成DOM Tree
2. 将CSS解析成CSSOM Tree（CSS不会影响DOM的解析，但是会阻塞DOM的渲染）
3. 将DOM Tree和 CSSOM Tree构建成渲染树

![img](images\7.png)

4. 进行重绘和回流
  - 重绘: 当页面中元素样式发生改变但是不影响它在文档流中的位置时(color,background-color)，浏览器会将新的样式赋予元素并重新绘制。
  - 回流: 当Render Tree中部分或全部元素的尺寸、结构或者某些属性发生改变时，浏览器重新渲染部分或全部文档的过程。

5. 渲染过程中遇到 `<script>`就会停止渲染,执行JS代码。 因为浏览器的GUI线程和JS引擎线程是互斥的,JS的加载、解析和渲染都会阻塞DOM的构建。一般将DOM放在底部或者给`<script>`加上defer和async属性。 由于JS可以改变css样式,如果JS想访问css并改变它，则在执行JS前就得拿到完成的CSSOM，因此这种情况下,浏览器会先下载和构建CSSOM，然后再执行JS，最后再构建DOM。

补充: 
**async和defer的区别:**  
![async和defer](images\8.png)
  - 默认情况下,浏览器会直接加载并执行脚本,不会等DOM加载完毕。
  - defer: 加载JS的阶段不会阻塞HTML解析,等到HTML解析完毕后执行JS代码。
  - async: 加载JS的阶段不会阻塞HTML解析,JS加载完毕立即执行,执行时会阻塞HTML解析。
​	
总结：执行时机不同, 并且加载多个JS脚本时,async是无序加载,defer是有序的。


##### 1.7 关闭连接
**四次挥手:**
  - 浏览器向服务器发送带有FIN标志的释放连接报文。
  - 服务器接收到后 向浏览器发送带有ACK标志的确认报文,浏览器接收到后就进入等待终止状态，等待服务器发送带有FIN标志的连接释放报文。(此时TCP处于半关闭状态,浏览器->服务器这个方向的连接已经被释放了,即浏览器无法再向服务器发送请求,但是服务器还可以向浏览器发送)
  - 当服务器没有要向浏览器发送的数据时,发送带有ACK和FIN标志的释放连接报文给浏览器。
  - 浏览器收到连接释放报文后,向服务器发出确认。此时TCP连接并不会马上释放，必须经过2MSL(最长报文段寿命)时间后,浏览器才会进入关闭状态。(注意:在第二次挥手后,TCP处在半关闭状态,浏览器无法发送请求,但是可以发送报文)

**为什么四次挥手释放连接时,要等待2MSL(maxmum segment 最大报文段寿命)？**
为了确保浏览器发送的最后一个确认报文能够到达服务器。因为如果最后一个报文丢失了，那么服务器没有收到报文,让浏览器重新确认，而浏览器已经关闭，那么服务器就无法正常的关闭。使用了2MSL,让浏览器稍作等待,如果报文丢失,服务器重新发送释放连接报文，浏览器回应并重置2MSL计时器,直至成功。

**为什么要四次挥手?**
服务器接收到客户端的带有FIN的请求报文后,先返回一个带有ACK标志的响应报文作为应答,需要等到数据都传输完成后,服务器才会返回带有FIN标志的响应报文断开连接。